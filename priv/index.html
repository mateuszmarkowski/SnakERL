<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript">
var ws = new Object;

class Snake {
	constructor(id, segments, color) {
		this.id = id;
		this.segments = segments;
		this.color = color;
	}
}

class Game {
	constructor(context) {
		this.snakes = {};
		this.context = context;
		this.sizeMultiplier = 10;
	}
	
	getRandomColor () {
		var colors = [
			'red',
			'blue',
			'pink',
			'purple',
			'green',
			'black'
		];
		
		return colors[Math.floor((Math.random(colors.length) * colors.length))];
	}
	
	addOrUpdateSnake(snake) {
		if (snake.id in this.snakes) {
			this.snakes[snake.id].segments = snake.segments;
		} else {
			this.snakes[snake.id] = snake;
			this.snakes[snake.id].color = this.getRandomColor();
		}
	}
	
	handleMessage(text) {
		var message = MessageDeserializer.deserialize(text);
		
		if (typeof message != 'object') {
			return;
		}
		
		switch (message.constructor.name) {
			case 'UpdateMessage':
				var snakeIds = [];
			
				for (var snake of message.snakes) {
					this.addOrUpdateSnake(snake);
					
					snakeIds.push(snake.id);
				}
				
				for (var snakeId in this.snakes) {
					if (snakeIds.indexOf(snakeId) < 0) {
						delete this.snakes[snakeId];
					}
				}
				
				this.render();
			break;
		}
	}
	
	coordsToSegment(x, y) {		
		return [
			x * this.sizeMultiplier,
			y * this.sizeMultiplier,
			this.sizeMultiplier,
			this.sizeMultiplier
		];
	}
	
	render() {
		this.context.fillStyle = 'red';
		this.context.fillRect(0, 0, 800, 400);
		
		for (var snakeId in this.snakes) {
			var snake = this.snakes[snakeId];
			
			this.context.fillStyle = snake.color;
			
			for (var segment of snake.segments) {				
				this.context.fillRect.apply(this.context, this.coordsToSegment(segment[0], segment[1]));
			}
		}
	}
}

class UpdateMessage {
	constructor(snakes) {
		this.snakes = snakes;
	}
}

class MessageDeserializer {
	static deserialize(text) {
		switch (text.slice(0, 2)) {
			case 'D#':
				var snakeTexts = text.slice(2).split('|'),
					snakes = [];
					
				for (var snakeText of snakeTexts) {
					var snakeId = snakeText.split('=')[0],
						segmentTexts = snakeText.split('=')[1].split(';'),
						segments = [],
						snake;
					
					segments = segmentTexts.map(function (segmentText) {
						var XY = segmentText.split(',');
						
						return [parseFloat(XY[0]), parseFloat(XY[1])];
					});
					
					snake = new Snake(snakeId, segments);
					
					snakes.push(snake);
				}
				
				return new UpdateMessage(snakes);
			break;
			
			case 'L#':
				
			break;
			
			default:
			
			break;
			
		}
	}
}

function start()
{
	ws.send("S#100,100");
}
function direction(dir)
{
	ws.send("D#"+dir);
}
function list()
{
	ws.send("L#");
}
function open()
{
	var canvas = document.getElementById('board');
	
	if (!("WebSocket" in window)) {
		alert("This browser does not support WebSockets");
		return;
	}
	/* @todo: Change to your own server IP address */
	ws = new WebSocket("ws://localhost:8080/websocket");

	ws.onopen = function() {
		console.log('Connected');
	};
	
	var game = new Game(canvas.getContext('2d'));
	
	ws.onmessage = function (evt)
	{
		var received_msg = evt.data;
		console.log("Received: " + received_msg);
		
		game.handleMessage(received_msg);
	};
	
	ws.onclose = function()
	{
		console.log('Connection closed');
	};
}

</script>
</head>
<body>
<div id="sse">
   <a href="javascript:open()">Open websocket connection</a><br/>
   <a href="javascript:start()">Start game</a><br/>
   <a href="javascript:list()">List games</a><br/>
   <a href="javascript:direction(1)">Up</a><br/>
   <a href="javascript:direction(3)">Down</a><br/>
   <a href="javascript:direction(2)">Right</a><br/>
   <a href="javascript:direction(4)">Left</a><br/>
</div>
<div id="msgs">
</div>

<canvas width="800" height="400" id="board">
</canvas>
</body>
</html>
